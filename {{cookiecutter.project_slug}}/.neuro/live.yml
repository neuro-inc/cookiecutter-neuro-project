kind: live
title: {{ cookiecutter.project_name }}
id: {{ cookiecutter.project_slug }}

defaults:
  preset: gpu-small
  life_span: 1d
  tags:
    - kind:project
    - project:project-slug-name-placeholder
    - project-id:project-uuid-placeholder

volumes:
  data:
    remote: storage:$[[ flow.id ]]/data
    mount: /project/data
    local: data
  code:
    remote: storage:$[[ flow.id ]]/{{ cookiecutter.code_directory }}
    mount: /project/{{ cookiecutter.code_directory }}
    local: {{ cookiecutter.code_directory }}
  config:
    remote: storage:$[[ flow.id ]]/config
    mount: /project/config
    local: config
    read_only: True
  notebooks:
    remote: storage:$[[ flow.id ]]/notebooks
    mount: /project/notebooks
    local: notebooks
  results:
    remote: storage:$[[ flow.id ]]/results
    mount: /project/results
    local: results
  project:
    remote: storage:$[[ flow.id ]]
    mount: /project
    local: .

images:
  {{ cookiecutter.project_slug }}:
    ref: image:$[[ flow.id ]]/develop
    dockerfile: $[[ flow.workspace ]]/Dockerfile
    context: $[[ flow.workspace ]]/

jobs:

  develop:
    image: $[[ images.{{ cookiecutter.project_slug }}.ref ]]
    # note, since the base image v1.6 redirects the output via '2>&1 | tee'
    # the image cannot run bash in interactive mode.
    # detach: True
    env:
      EXPOSE_SSH: "yes"
      PYTHONPATH: $[[ volumes.code.mount ]]
    port_forward:
      - "2211:22"
    volumes:
      - $[[ volumes.data.ref_ro ]]
      - $[[ volumes.code.ref_rw ]]
      - $[[ volumes.config.ref_rw ]]
      - $[[ volumes.results.ref_rw ]]
    cmd: bash

  train:
    image: $[[ images.{{ cookiecutter.project_slug }}.ref ]]
    detach: True
    life_span: 10d
    volumes:
      - $[[ volumes.data.ref_ro ]]
      - $[[ volumes.code.ref_ro ]]
      - $[[ volumes.config.ref_ro ]]
      - $[[ volumes.results.ref_rw ]]
    env:
      EXPOSE_SSH: "yes"
      PYTHONPATH: $[[ volumes.code.mount ]]
    bash: |
        cd $[[ volumes.project.mount ]]
        python -u $[[ volumes.code.mount ]]/train.py --data $[[ volumes.data.mount ]]

  multitrain:
    image: $[[ images.{{ cookiecutter.project_slug }}.ref ]]
    detach: True
    life_span: 10d
    volumes:
      - $[[ volumes.data.ref_ro ]]
      - $[[ volumes.code.ref_ro ]]
      - $[[ volumes.config.ref_ro ]]
      - $[[ volumes.results.ref_rw ]]
    env:
      EXPOSE_SSH: "yes"
      PYTHONPATH: $[[ volumes.code.mount ]]
    multi: true
    bash: |
        cd $[[ volumes.project.mount ]]
        python $[[ volumes.code.mount ]]/train.py --data $[[ volumes.data.mount ]] $[[ multi.args ]]

  jupyter_notebook:
    image: $[[ images.{{ cookiecutter.project_slug }}.ref ]]
    http_port: 8888
    http_auth: True
    browse: True
    detach: True
    volumes:
      - $[[ volumes.data.ref_ro ]]
      - $[[ volumes.code.ref_rw ]]
      - $[[ volumes.config.ref_ro ]]
      - $[[ volumes.notebooks.ref_rw ]]
      - $[[ volumes.results.ref_rw ]]
    env:
      PYTHONPATH: $[[ volumes.code.mount ]]
    cmd: >-
      jupyter notebook
        --no-browser
        --ip=0.0.0.0
        --allow-root
        --NotebookApp.token=
        --notebook-dir=$[[ volumes.notebooks.mount ]]

  jupyter_lab:
    image: $[[ images.{{ cookiecutter.project_slug }}.ref ]]
    http_port: 8888
    http_auth: True
    browse: True
    detach: True
    volumes:
      - $[[ volumes.data.ref_ro ]]
      - $[[ volumes.code.ref_rw ]]
      - $[[ volumes.config.ref_ro ]]
      - $[[ volumes.notebooks.ref_rw ]]
      - $[[ volumes.results.ref_rw ]]
    env:
      PYTHONPATH: $[[ volumes.code.mount ]]
    cmd: >-
      jupyter lab
        --no-browser
        --ip=0.0.0.0
        --allow-root
        --NotebookApp.token=
        --notebook-dir=$[[ volumes.notebooks.mount ]]

  tensorboard:
    image: tensorflow/tensorflow:latest
    preset: cpu-small
    http_port: 6006
    http_auth: True
    browse: True
    detach: True
    volumes:
      - $[[ volumes.results.ref_ro ]]
    cmd: tensorboard --host=0.0.0.0 --logdir=$[[ volumes.results.mount ]]

  filebrowser:
    image: filebrowser/filebrowser:latest
    preset: cpu-small
    http_port: 80
    http_auth: True
    browse: True
    detach: True
    volumes:
      - $[[ volumes.project.remote ]]:/srv:rw
    cmd: --noauth
